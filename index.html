<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>é€†å¼•ãè¾²è–¬è¾å…¸</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 18px; }
    .section-title { margin-top: 24px; margin-bottom: 12px; }
    #detail .card { margin-bottom: 12px; }
  </style>
</head>
<body>

  <style>
    .particle {
      position: absolute;
      font-size: 24px;
      pointer-events: none;
      animation: floatUp 3000ms ease-out forwards; /* â† 5ç§’ã«å»¶é•· */
    }
  
    @keyframes floatUp {
  0% {
    opacity: 1;
    transform: translate(0, 0) scale(1);
  }
  60% {
    opacity: 0.8;
    transform: translate(var(--x), calc(var(--y) * 0.7)) scale(1.1); /* å°‘ã—å¤§ããè†¨ã‚‰ã‚€ */
  }
  100% {
    opacity: 0;
    transform: translate(var(--x), var(--y)) scale(0.8); /* å°‘ã—ç¸®ã‚“ã§æ¶ˆãˆã‚‹ */
  }
}
  </style>
  
  <script>
  function spawnParticles(button, type) {
    const rect = button.getBoundingClientRect();
    const icons = {
      FRAC: "ğŸ¦ ",
      IRAC: "ğŸ›",
      HRAC: "ğŸŒ±"
    };
  
    for (let i = 0; i < 5; i++) {
      const span = document.createElement("span");
      span.className = "particle";
      span.textContent = icons[type] || "âœ¨";
  
      // ãƒœã‚¿ãƒ³ã®ä¸­å¿ƒã‹ã‚‰å‡ºã™
      span.style.left = rect.left + rect.width / 2 + window.scrollX + "px";
      span.style.top = rect.top + rect.height / 2 + window.scrollY + "px";

      // å·¦å³ãƒ©ãƒ³ãƒ€ãƒ  Â±40pxã€ä¸Šæ–¹å‘ 100ã€œ200px
      const x = (Math.random() - 0.5) * 80;
      const y = - (100 + Math.random() * 100);

      span.style.setProperty("--x", `${x}px`);
      span.style.setProperty("--y", `${y}px`);

      document.body.appendChild(span);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å‰Šé™¤
      span.addEventListener("animationend", () => {
        span.remove();
      });
  }
}
      

  
  // RACãƒœã‚¿ãƒ³ã«é©ç”¨
  document.addEventListener("click", function(e) {
    if (e.target.classList.contains("rac-btn")) {
      const type = e.target.dataset.type;
      spawnParticles(e.target, type);
    }
  });
  </script>


  <div class="container">
    <h1 class="mb-2">é€†å¼•ãè¾²è–¬è¾å…¸ï¼ˆèŠç”Ÿç”¨ï¼‰</h1>
    <div class="text-muted" style="margin-bottom:2px; line-height:1.2; font-size:1.1em;">
      ç—…å®³ãƒ»å®³è™«ãƒ»é›‘è‰åã‚’å…¥åŠ›ã—ã¦ã€ãã‚Œã«å¯¾å¿œã™ã‚‹è¾²è–¬ã‚’é€†å¼•ãæ¤œç´¢ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ 
    </div>
    <div style="margin-bottom:28px; line-height:1;"><span style="font-size:1em;">v0.91 2025/10/6</span></div>


    <div class="input-group mb-3">
      <input type="text" id="keyword" class="form-control" placeholder="ç—…å®³ãƒ»å®³è™«ãƒ»é›‘è‰åã‚’å…¥åŠ›ï¼ˆä¾‹: ã†ã©ã‚“ã“ç—…ã€ã‚¢ãƒ–ãƒ©ãƒ ã‚·ã€ã‚¹ã‚®ãƒŠï¼‰">
      <button class="btn btn-primary" id="searchBtn">æ¤œç´¢</button>
    </div>

    <h3 class="section-title">æ¤œç´¢çµæœ</h3>
    <div id="results">æ¤œç´¢ã—ã¦ä¸‹ã•ã„</div>

    <h3 class="section-title">è¾²è–¬è©³ç´°</h3>
    <div id="detail"></div>
  </div>

  <!-- Footer -->
  <footer class="text-center mt-5 py-3">
    <div class="container">
      <p class="mb-1">Â©2025 Growth and Progress</p>
      <p class="mb-0">
        <a href="https://www.turf-tools.jp/" target="_blank" class="text-decoration-none">ã‚°ãƒ­ã‚¦ã‚¢ãƒ³ãƒ‰ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹</a>
      </p>
    </div>
  </footer>

<script>
/*
  é‡è¦: ã“ã® index.html ã¯ search_server.jsï¼ˆç¾åœ¨ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ï¼‰ã®
  è¿”å´ã‚­ãƒ¼ï¼ˆç”¨é€”_x, è¾²è–¬ã®åç§°_x, æ­£å¼åç§°ï¼‰ã¨ã‚¯ã‚¨ãƒªå(regNo)ã«åˆã‚ã›ã¦ã‚ã‚Šã¾ã™ã€‚
*/

let currentDetail = null;

// æ¤œç´¢ãƒœã‚¿ãƒ³ã¨ Enter ã«ãƒã‚¤ãƒ³ãƒ‰
document.getElementById("searchBtn").addEventListener("click", doSearch);
document.getElementById("keyword").addEventListener("keydown", (e) => { if (e.key === "Enter") doSearch(); });

// --- æ¤œç´¢ ---
async function doSearch() {
  const keyword = document.getElementById("keyword").value.trim();
  if (!keyword) return;
  console.log("ğŸ” é€†æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰:", keyword);

  try {
    const res = await fetch(`/search?keyword=${encodeURIComponent(keyword)}`);
    const data = await res.json();
    console.log("ğŸ” /search result:", data);

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      resultsDiv.innerHTML = "<div class='alert alert-warning'>è©²å½“ã™ã‚‹è¾²è–¬ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>";
      document.getElementById("detail").innerHTML = "";
      return;
    }

    // ã‚µãƒ¼ãƒãƒ¼ã¯ { ç™»éŒ²ç•ªå·, ç”¨é€”_x, è¾²è–¬ã®åç§°_x, æ­£å¼åç§°, é©ç”¨ç—…å®³è™«é›‘è‰å } ã‚’è¿”ã—ã¾ã™
    let html = `<table class="table table-striped table-hover"><thead><tr>
      <th>ç™»éŒ²ç•ªå·</th><th>ç”¨é€”</th><th>è¾²è–¬ã®åç§°</th><th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th><th>é©ç”¨å¯¾è±¡</th><th></th>
    </tr></thead><tbody>`;

    data.forEach(row => {
      html += `<tr>
        <td>${row["ç™»éŒ²ç•ªå·"] ?? "ï¼"}</td>
        <td>${row["ç”¨é€”_x"] ?? "ï¼"}</td>
        <td>${row["è¾²è–¬ã®åç§°_x"] ?? "ï¼"}</td>
        <td>${row["æ­£å¼åç§°"] ?? "ï¼"}</td>
        <td>${row["é©ç”¨ç—…å®³è™«é›‘è‰å"] ?? "ï¼"}</td>
        <td><button class="btn btn-sm btn-primary" onclick="loadDetail(${JSON.stringify(row["ç™»éŒ²ç•ªå·"])})">é¸æŠ</button></td>
      </tr>`;
    });

    html += "</tbody></table>";
    resultsDiv.innerHTML = html;
    document.getElementById("detail").innerHTML = "";

  } catch (err) {
    console.error("æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", err);
    alert("æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‚ç…§ï¼‰ã€‚");
  }
}

// --- è©³ç´°ã‚’ãƒ­ãƒ¼ãƒ‰ (ã‚µãƒ¼ãƒãƒ¼å´ã¯ regNo ã‚’æœŸå¾…ï¼‰---
async function loadDetail(regNo) {
  console.log("ğŸ“¡ /detail å‘¼ã³å‡ºã— regNo=", regNo);
  try {
    const res = await fetch(`/detail?regNo=${encodeURIComponent(regNo)}`);
    const data = await res.json();
    console.log("ğŸ“¥ /detail data:", data);
    // data ã¯ { detail: [...], racList: [...] }
    if (!data || !data.detail) {
      alert("è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªï¼‰ã€‚");
      return;
    }
    currentDetail = data;
    renderDetail(data);
  } catch (err) {
    console.error("detail å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    alert("è©³ç´°å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‚ç…§ï¼‰ã€‚");
  }
}

// --- è©³ç´°è¡¨ç¤ºï¼ˆåŸºæœ¬æƒ…å ± + ãƒœã‚¿ãƒ³ç¾¤ + subviewï¼‰ ---
function renderDetail(data) {
  const detailDiv = document.getElementById("detail");
  detailDiv.innerHTML = "";

  const basic = data.detail[0] || {};
  // åŸºæœ¬æƒ…å ±ã‚«ãƒ¼ãƒ‰
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `<div class="card-body">
    <h5 class="card-title">${basic["è¾²è–¬ã®åç§°_x"] ?? "ï¼"}</h5>
    <p class="card-text">ç™»éŒ²ç•ªå·: ${basic["ç™»éŒ²ç•ªå·"] ?? "ï¼"}<br>
    ç”¨é€”: ${basic["ç”¨é€”_x"] ?? "ï¼"}<br>
    ãƒ¡ãƒ¼ã‚«ãƒ¼: ${basic["æ­£å¼åç§°"] ?? "ï¼"}</p>
  </div>`;
  detailDiv.appendChild(card);

  // ãƒœã‚¿ãƒ³ç¾¤ï¼ˆé©ç”¨æƒ…å ± + RACã‚³ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼‰
  const btnGroup = document.createElement("div");
  btnGroup.className = "btn-group my-2";
  // é©ç”¨æƒ…å ±ãƒœã‚¿ãƒ³
  const applyBtn = document.createElement("button");
  applyBtn.className = "btn btn-outline-success active";
  applyBtn.innerText = "é©ç”¨æƒ…å ±";
  applyBtn.onclick = () => { showUsageInfo(); setActiveBtn(applyBtn); };
  btnGroup.appendChild(applyBtn);

  // RACãƒœã‚¿ãƒ³ï¼ˆserver ãŒè¿”ã™ racList ã«åŸºã¥ãï¼‰
  (data.racList || []).forEach((r, idx) => {
    const b = document.createElement("button");
    b.className = "btn btn-outline-primary rac-btn";
    b.dataset.type = r.rac_type; // FRAC / IRAC / HRAC
    b.textContent = `[${r.rac_type} ${r.rac_code}]`;
    b.innerText = `[${r.rac_type}-${r.rac_code}]`;
    b.onclick = () => { showRacInfo(r.rac_type, r.rac_code); setActiveBtn(b); };
    btnGroup.appendChild(b);
  });

  // no RAC ã®å ´åˆã¯ disabled è¡¨ç¤º
  if (!Array.isArray(data.racList) || data.racList.length === 0) {
    const n = document.createElement("button");
    n.className = "btn btn-outline-secondary disabled";
    n.innerText = "RACãªã—";
    btnGroup.appendChild(n);
  }

  detailDiv.appendChild(btnGroup);

  // subview ã‚’ä½œã‚‹ï¼ˆã“ã“ã«é©ç”¨æƒ…å ± or RACæƒ…å ±ãŒå…¥ã‚‹ï¼‰
  const subview = document.createElement("div");
  subview.id = "subview";
  detailDiv.appendChild(subview);

  // åˆæœŸã¯é©ç”¨æƒ…å ±è¡¨ç¤º
  showUsageInfo();
}

// ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function setActiveBtn(btn) {
  const parent = btn.parentNode;
  if (!parent) return;
  Array.from(parent.querySelectorAll("button")).forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

// --- é©ç”¨æƒ…å ±ã‚’ subview ã«å‡ºåŠ› ---
function showUsageInfo() {
  const sub = document.getElementById("subview");
  if (!currentDetail || !currentDetail.detail) { sub.innerHTML = "<div class='alert alert-warning'>é©ç”¨æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>"; return; }

  const rows = currentDetail.detail;
  let html = `<h5>é©ç”¨æƒ…å ±</h5>
    <table class="table table-bordered table-sm"><thead><tr>
      <th>ä½œç‰©å</th><th>é©ç”¨å ´æ‰€</th><th>é©ç”¨ç—…å®³è™«é›‘è‰å</th>
      <th>æœ‰åŠ¹æˆåˆ†</th><th>æ¿ƒåº¦</th><th>å¸Œé‡ˆå€ç‡ä½¿ç”¨é‡</th><th>æ•£å¸ƒæ¶²é‡</th>
      <th>ä½¿ç”¨æ™‚æœŸ</th><th>ç·ä½¿ç”¨å›æ•°</th><th>ä½¿ç”¨æ–¹æ³•</th>
    </tr></thead><tbody>`;

  rows.forEach(r => {
    html += `<tr>
      <td>${r["ä½œç‰©å"] ?? "ï¼"}</td>
      <td>${r["é©ç”¨å ´æ‰€"] ?? "ï¼"}</td>
      <td>${r["é©ç”¨ç—…å®³è™«é›‘è‰å"] ?? "ï¼"}</td>
      <td>${r["æœ‰åŠ¹æˆåˆ†"] ?? "ï¼"}</td>
      <td>${r["æ¿ƒåº¦"] ?? "ï¼"}</td>
      <td>${r["å¸Œé‡ˆå€æ•°ä½¿ç”¨é‡"] ?? "ï¼"}</td>
      <td>${r["æ•£å¸ƒæ¶²é‡"] ?? "ï¼"}</td>
      <td>${r["ä½¿ç”¨æ™‚æœŸ"] ?? "ï¼"}</td>
      <td>${r["æœ‰åŠ¹æˆåˆ†â‘ ã‚’å«ã‚€è¾²è–¬ã®ç·ä½¿ç”¨å›æ•°"] ?? r["ç·ä½¿ç”¨å›æ•°"] ?? "ï¼"}</td>
      <td>${r["ä½¿ç”¨æ–¹æ³•"] ?? "ï¼"}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  sub.innerHTML = html;
}

// --- RACæƒ…å ±ã¨åŒä¸€ã‚°ãƒ«ãƒ¼ãƒ—è¾²è–¬ ---
async function showRacInfo(type, code) {
  const sub = document.getElementById("subview");
  sub.innerHTML = "<div class='text-muted'>èª­ã¿è¾¼ã¿ä¸­...</div>";

  try {
    const res = await fetch(`/racgroup?type=${encodeURIComponent(type)}&code=${encodeURIComponent(code)}`);
    const group = await res.json();

    // RACè©³ç´°è¡¨ï¼ˆcurrentDetail.racList ã‹ã‚‰è©²å½“é …ç›®ã‚’å–ã‚Šå‡ºã™ï¼‰
    const racDetail = (currentDetail.racList || []).find(r => String(r.rac_type) === String(type) && String(r.rac_code) === String(code));

    let html = `<h5>RACæƒ…å ±</h5>`;
    html += `<table class="table table-bordered table-sm"><thead><tr>
      <th>RACã‚¿ã‚¤ãƒ—</th><th>RACã‚³ãƒ¼ãƒ‰</th><th>ã‚°ãƒ«ãƒ¼ãƒ—å</th><th>ä½œç”¨æ©Ÿæ§‹</th><th>æˆåˆ†å</th><th>å‚™è€ƒ</th>
    </tr></thead><tbody>`;

    if (racDetail) {
      html += `<tr>
        <td>${racDetail.rac_type}</td>
        <td>${racDetail.rac_code}</td>
        <td>${racDetail.group_name}</td>
        <td>${racDetail.made_of_action}</td>
        <td>${racDetail.examples}</td>
        <td>${racDetail.remarks || "ï¼"}</td>
      </tr>`;
    } else {
      html += `<tr><td colspan="6">RACæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>`;
    }
    html += `</tbody></table>`;

    // åŒä¸€ã‚°ãƒ«ãƒ¼ãƒ—è¾²è–¬ä¸€è¦§
    html += `<h6 class="mt-3">åŒä¸€ã‚°ãƒ«ãƒ¼ãƒ—è¾²è–¬</h6>`;
    if (!Array.isArray(group) || group.length === 0) {
      html += `<div class="alert alert-secondary">åŒä¸€ã‚°ãƒ«ãƒ¼ãƒ—ã®è¾²è–¬ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>`;
    } else {
      html += `<table class="table table-sm table-striped"><thead><tr><th>ç™»éŒ²ç•ªå·</th><th>è¾²è–¬ã®åç§°</th><th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th></tr></thead><tbody>`;
      group.forEach(e => {
        html += `<tr>
          <td>${e["ç™»éŒ²ç•ªå·"] ?? "ï¼"}</td>
          <td>${e["è¾²è–¬ã®åç§°_x"] ?? "ï¼"}</td>
          <td>${e["æ­£å¼åç§°"] ?? "ï¼"}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
    }

    sub.innerHTML = html;

  } catch (err) {
    console.error("racgroup å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    sub.innerHTML = "<div class='alert alert-danger'>RACæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>";
  }
}
</script>
</body>
</html>
